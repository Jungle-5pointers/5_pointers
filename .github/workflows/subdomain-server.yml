name: Deploy Subdomain Server to AWS EC2 (Improved)

on:
  push:
    branches: [main]
    paths:
      - 'subdomain-server.js'
      - '.github/workflows/subdomain-server.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ap-northeast-2

      - name: Deploy to EC2 via SSM
        run: |
          echo "ğŸš€ ì„œë¸Œë„ë©”ì¸ ì„œë²„ ë°°í¬ ì‹œì‘..."
          
          # ì¸ìŠ¤í„´ìŠ¤ ID ê°€ì ¸ì˜¤ê¸°
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=PageCube-Subdomain-Simple" "Name=instance-state-name,Values=running" \
            --query 'Reservations[].Instances[].InstanceId' \
            --output text)
          
          if [ -z "$INSTANCE_ID" ] || [ "$INSTANCE_ID" = "None" ]; then
            echo "âŒ ì‹¤í–‰ ì¤‘ì¸ PageCube-Subdomain-Simple ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          
          echo "âœ… ì¸ìŠ¤í„´ìŠ¤ ID: $INSTANCE_ID"
          
          # S3ì— íŒŒì¼ ì—…ë¡œë“œ
          aws s3 cp subdomain-server.js s3://elasticbeanstalk-ap-northeast-2-490004614784/github-deploy/
          
          # SSMì„ í†µí•´ ë°°í¬ ëª…ë ¹ ì‹¤í–‰
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids $INSTANCE_ID \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "#!/bin/bash",
              "set -e",
              "echo \"ğŸ”„ ì„œë¸Œë„ë©”ì¸ ì„œë²„ ì—…ë°ì´íŠ¸ ì‹œì‘...\"",
              "cd /home/ssm-user",
              "# ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ",
              "pkill -f subdomain-server || true",
              "sleep 3",
              "# ìƒˆ íŒŒì¼ ë‹¤ìš´ë¡œë“œ",
              "aws s3 cp s3://elasticbeanstalk-ap-northeast-2-490004614784/github-deploy/subdomain-server.js ./ --region ap-northeast-2",
              "# ì„œë²„ ë°±ê·¸ë¼ìš´ë“œ ì‹œì‘",
              "nohup node subdomain-server.js > server.log 2>&1 &",
              "sleep 5",
              "# í—¬ìŠ¤ì²´í¬",
              "if curl -f http://localhost:3001/health; then",
              "  echo \"âœ… ì„œë¸Œë„ë©”ì¸ ì„œë²„ ì—…ë°ì´íŠ¸ ì„±ê³µ!\"",
              "else",
              "  echo \"âŒ ì„œë²„ ì‹œì‘ ì‹¤íŒ¨\"",
              "  tail -20 server.log",
              "  exit 1",
              "fi"
            ]' \
            --query 'Command.CommandId' \
            --output text)
          
          echo "ğŸ“‹ ëª…ë ¹ ID: $COMMAND_ID"
          
          # ëª…ë ¹ ì‹¤í–‰ ì™„ë£Œ ëŒ€ê¸°
          echo "â³ ë°°í¬ ëª…ë ¹ ì‹¤í–‰ ëŒ€ê¸° ì¤‘..."
          aws ssm wait command-executed \
            --command-id $COMMAND_ID \
            --instance-id $INSTANCE_ID \
            --max-attempts 30 \
            --delay 10
          
          # ì‹¤í–‰ ê²°ê³¼ í™•ì¸
          RESULT=$(aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id $INSTANCE_ID \
            --query 'Status' \
            --output text)
          
          if [ "$RESULT" = "Success" ]; then
            echo "âœ… ë°°í¬ ì„±ê³µ!"
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
            aws ssm get-command-invocation \
              --command-id $COMMAND_ID \
              --instance-id $INSTANCE_ID \
              --query 'StandardErrorContent' \
              --output text
            exit 1
          fi

      - name: Health Check
        run: |
          # í˜„ì¬ IP ì£¼ì†Œ ê°€ì ¸ì˜¤ê¸°
          CURRENT_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=PageCube-Subdomain-Simple" "Name=instance-state-name,Values=running" \
            --query 'Reservations[].Instances[].PublicIpAddress' \
            --output text)
          
          echo "ğŸŒ í˜„ì¬ IP: $CURRENT_IP"
          
          # í—¬ìŠ¤ì²´í¬
          echo "ğŸ” í—¬ìŠ¤ì²´í¬ ìˆ˜í–‰ ì¤‘..."
          for i in {1..10}; do
            if curl -f --connect-timeout 10 http://$CURRENT_IP:3001/health; then
              echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ!"
              echo "ğŸ”— ì„œë²„ ì£¼ì†Œ: http://$CURRENT_IP:3001"
              echo "ğŸŒ ì„œë¸Œë„ë©”ì¸ í…ŒìŠ¤íŠ¸: curl -H 'Host: test.pagecube.net' http://$CURRENT_IP:3001"
              exit 0
            fi
            echo "â³ ì¬ì‹œë„ ì¤‘... ($i/10)"
            sleep 10
          done
          
          echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
          exit 1
