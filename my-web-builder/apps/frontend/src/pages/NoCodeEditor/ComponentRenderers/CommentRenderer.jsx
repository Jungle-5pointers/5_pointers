import React, { useState, useEffect } from 'react';
import { API_BASE_URL } from '../../../config';

// ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ìè∞Ìä∏ Î™©Î°ù
const AVAILABLE_FONTS = [
  'Playfair Display',
  'Adelio Darmanto',
  'Bodoni',
  'Brooke Smith Script',
  'Chalisa Oktavia',
  'Dearly Loved One',
  'Deluxe Edition',
  'Dreamland',
  'EB Garamond',
  'Elsie',
  'England Hand',
  'Hijrnotes',
  'La Paloma',
  'Millerstone',
  'Montserrat',
  'Pinyon Script',
  'Prata',
  'Underland'
];

function CommentRenderer({ comp, mode = 'editor', viewport = 'desktop', pageId }) {
  const { title, placeholder, backgroundColor } = comp.props;
  const [comments, setComments] = useState([]);
  const [newComment, setNewComment] = useState({
    author: '',
    content: '',
    password: '',
  });
  const [showDeleteModal, setShowDeleteModal] = useState(null);
  const [deletePassword, setDeletePassword] = useState('');

  // ÎåìÍ∏Ä Î™©Î°ù Ï°∞Ìöå
  const fetchComments = async () => {
    if (mode === 'editor') return; // ÏóêÎîîÌÑ∞ Î™®ÎìúÏóêÏÑúÎäî API Ìò∏Ï∂ú ÏïàÌï®

    const actualPageId = pageId || comp.pageId;
    const actualApiBaseUrl = API_BASE_URL || (typeof window !== 'undefined' ? window.API_BASE_URL : null);
    
    if (!actualPageId || !actualApiBaseUrl) {
      return;
    }

    try {
      const apiUrl = `${actualApiBaseUrl}/users/pages/${actualPageId}/comments/${comp.id}`;
      
      const response = await fetch(apiUrl);
      console.log('üöÄ CommentRenderer - API ÏùëÎãµ ÏÉÅÌÉú:', response.status);
      
      if (response.ok) {
        const data = await response.json();
        console.log('üöÄ CommentRenderer - API ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:', data);
        setComments(data);
      } else {
        console.error('‚ùå CommentRenderer - API ÏùëÎãµ Ïò§Î•ò:', response.status, response.statusText);
      }
    } catch (error) {
      console.error('‚ùå CommentRenderer - ÎåìÍ∏Ä Ï°∞Ìöå Ïã§Ìå®:', error);
    }
  };

  // ÎåìÍ∏Ä ÏûëÏÑ±
  const handleSubmitComment = async (e) => {
    e.preventDefault();
    if (!newComment.author || !newComment.content || !newComment.password) {
      alert('Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
      return;
    }

    const actualPageId = pageId || comp.pageId;
    const actualApiBaseUrl = API_BASE_URL || (typeof window !== 'undefined' ? window.API_BASE_URL : null);
    
    console.log('üöÄ CommentRenderer - handleSubmitComment Ìò∏Ï∂ú');
    console.log('üöÄ CommentRenderer - actualPageId:', actualPageId);
    console.log('üöÄ CommentRenderer - actualApiBaseUrl:', actualApiBaseUrl);
    console.log('üöÄ CommentRenderer - comp.id:', comp.id);
    console.log('üöÄ CommentRenderer - newComment:', newComment);
    
    if (!actualPageId || !actualApiBaseUrl) {
      console.error('‚ùå CommentRenderer - pageId ÎòêÎäî API_BASE_URLÏù¥ ÏóÜÏäµÎãàÎã§', {
        actualPageId,
        actualApiBaseUrl,
        comp: comp
      });
      alert('ÌéòÏù¥ÏßÄ Ï†ïÎ≥¥Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. ÌéòÏù¥ÏßÄÎ•º ÏÉàÎ°úÍ≥†Ïπ®Ìï¥Ï£ºÏÑ∏Ïöî.');
      return;
    }

    try {
      const apiUrl = `${actualApiBaseUrl}/users/pages/${actualPageId}/comments/${comp.id}`;
      console.log('üöÄ CommentRenderer - POST API Ìò∏Ï∂ú URL:', apiUrl);
      
      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newComment),
      });

      if (response.ok) {
        const result = await response.json();
        
        setNewComment({ author: '', content: '', password: '' });
        await fetchComments(); // ÎåìÍ∏Ä Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
        // alert('ÎåìÍ∏ÄÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.');
      } else {
        const errorText = await response.text();
        console.error('API ÏùëÎãµ ÏóêÎü¨:', {
          status: response.status,
          statusText: response.statusText,
          body: errorText
        });
        alert(`ÎåìÍ∏Ä Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. (${response.status}: ${response.statusText})`);
      }
    } catch (error) {
      console.error('ÎåìÍ∏Ä Îì±Î°ù Ïã§Ìå®:', error);
      alert(`ÎåìÍ∏Ä Îì±Î°ùÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. ÎÑ§Ìä∏ÏõåÌÅ¨ Ïò§Î•ò: ${error.message}`);
    }
  };

  // ÎåìÍ∏Ä ÏÇ≠Ï†ú
  const handleDeleteComment = async () => {
    if (!deletePassword) {
      alert('ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
      return;
    }

    try {
      const response = await fetch(
        `${API_BASE_URL}/users/pages/${comp.pageId}/comments/${comp.id}/${showDeleteModal}`,
        {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: deletePassword }),
        }
      );

      if (response.ok) {
        setShowDeleteModal(null);
        setDeletePassword('');
        fetchComments(); // ÎåìÍ∏Ä Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
      } else {
        alert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.');
      }
    } catch (error) {
      console.error('ÎåìÍ∏Ä ÏÇ≠Ï†ú Ïã§Ìå®:', error);
      alert('ÎåìÍ∏Ä ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
    }
  };

  useEffect(() => {
    fetchComments();
  }, [comp.id, comp.pageId, mode]);

  // viewportÏóê Îî∞Î•∏ Î∞òÏùëÌòï Ïä§ÌÉÄÏùº Í≥ÑÏÇ∞
  const getResponsiveStyles = () => {
    const isMobile = viewport === 'mobile';

    return {
      containerPadding: isMobile ? '16px' : '24px',
      titleFontSize: isMobile ? '16px' : '18px',
      inputPadding: isMobile ? '6px 10px' : '8px 12px',
      inputFontSize: isMobile ? '13px' : '14px',
      buttonPadding: isMobile ? '6px 12px' : '8px 16px',
      commentPadding: isMobile ? '12px' : '16px',
      minWidth: isMobile ? '200px' : '250px',
      minHeight: isMobile ? '120px' : '150px',
      gridColumns: isMobile ? '1fr' : '1fr 1fr',
      textareaHeight: isMobile ? '60px' : '80px',
    };
  };

  const styles = getResponsiveStyles();

  // Ìè∞Ìä∏ Í¥ÄÎ†® ÏÜçÏÑ±Îì§
  const fontFamily = comp.props?.fontFamily || 'Playfair Display, serif';
  const textAlign = comp.props?.textAlign || 'left';
  const lineHeight = comp.props?.lineHeight || 1.2;
  const letterSpacing = comp.props?.letterSpacing || 0;
  const fontWeight = comp.props?.fontWeight ? 'bold' : 'normal';
  const textDecoration = comp.props?.textDecoration ? 'underline' : 'none';
  const isItalic = comp.props?.fontStyle;
  const italicTransform = isItalic ? 'skewX(-15deg)' : 'none';

  return (
    <div
      style={{
        width: '100%',
        height: '100%',
        borderRadius: 0,
        border: '1px solid #e5e7eb',
        backgroundColor,
        display: 'flex',
        flexDirection: 'column',
        overflow: 'auto',
        fontFamily: fontFamily,
        padding: styles.containerPadding,
      }}
    >
      <h3
        style={{
          fontSize: styles.titleFontSize,
          fontWeight: fontWeight === 'bold' ? 'bold' : '600',
          marginBottom: '16px',
          color: comp.props?.color || '#1f2937',
          whiteSpace: 'pre-wrap',
          fontFamily: fontFamily,
          textAlign: textAlign,
          lineHeight: lineHeight,
          letterSpacing: letterSpacing + 'px',
          textDecoration: textDecoration,
          transform: italicTransform,
        }}
      >
        {title || 'Ï∂ïÌïò Î©îÏÑ∏ÏßÄÎ•º ÎÇ®Í≤®Ï£ºÏÑ∏Ïöî'}
      </h3>

      {/* ÎåìÍ∏Ä ÏûëÏÑ± Ìèº */}
      <form
        onSubmit={handleSubmitComment}
        style={{
          marginBottom: viewport === 'mobile' ? '16px' : '24px',
          padding: styles.commentPadding,
          backgroundColor: '#f9fafb',
          borderRadius: '8px',
        }}
      >
        <div
          style={{
            display: 'flex',
            flexDirection: 'column', 
            gridTemplateColumns: styles.gridColumns,
            gap: viewport === 'mobile' ? '8px' : '12px',
            marginBottom: viewport === 'mobile' ? '8px' : '12px',
          }}
        >
          <input
            type="text"
            placeholder="Ïù¥Î¶Ñ"
            value={newComment.author}
            onChange={(e) =>
              setNewComment({ ...newComment, author: e.target.value })
            }
            style={{
              padding: styles.inputPadding,
              border: '1px solid #d1d5db',
              borderRadius: '6px',
              fontSize: styles.inputFontSize,
              outline: 'none',
            }}
            onFocus={(e) => (e.target.style.borderColor = '#3b82f6')}
            onBlur={(e) => (e.target.style.borderColor = '#d1d5db')}
          />
          <input
            type="password"
            placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏"
            value={newComment.password}
            onChange={(e) =>
              setNewComment({ ...newComment, password: e.target.value })
            }
            style={{
              padding: styles.inputPadding,
              border: '1px solid #d1d5db',
              borderRadius: '6px',
              fontSize: styles.inputFontSize,
              outline: 'none',
            }}
            onFocus={(e) => (e.target.style.borderColor = '#3b82f6')}
            onBlur={(e) => (e.target.style.borderColor = '#d1d5db')}
          />
        </div>
        <textarea
          placeholder={placeholder || 'ÎåìÍ∏ÄÏùÑ ÎÇ®Í≤®Ï£ºÏÑ∏Ïöî'}
          value={newComment.content}
          onChange={(e) =>
            setNewComment({ ...newComment, content: e.target.value })
          }
          style={{
            width: '100%',
            padding: styles.inputPadding,
            border: '1px solid #d1d5db',
            borderRadius: '6px',
            fontSize: styles.inputFontSize,
            outline: 'none',
            resize: 'none',
            minHeight: styles.textareaHeight,
            whiteSpace: 'pre-wrap', // ‚úÖ
          }}
          onFocus={(e) => (e.target.style.borderColor = '#3b82f6')}
          onBlur={(e) => (e.target.style.borderColor = '#d1d5db')}
          rows="3"
        />
        <button
          type="submit"
          disabled={mode === 'editor'}
          style={{
            marginTop: viewport === 'mobile' ? '8px' : '12px',
            padding: styles.buttonPadding,
            borderRadius: '6px',
            fontSize: styles.inputFontSize,
            border: 'none',
            cursor: mode === 'editor' ? 'not-allowed' : 'pointer',
            backgroundColor: mode === 'editor' ? '#d1d5db' : '#2563eb',
            color: mode === 'editor' ? '#6b7280' : '#ffffff',
            transition: 'background-color 0.2s',
            whiteSpace: 'pre-wrap', // ‚úÖ
          }}
          onMouseOver={(e) => {
            if (mode !== 'editor') e.target.style.backgroundColor = '#1d4ed8';
          }}
          onMouseOut={(e) => {
            if (mode !== 'editor') e.target.style.backgroundColor = '#2563eb';
          }}
        >
          {mode === 'editor' ? 'Î∞∞Ìè¨ ÌõÑ ÏÇ¨Ïö© Í∞ÄÎä•' : 'ÎåìÍ∏Ä ÏûëÏÑ±'}
        </button>
      </form>

      {/* ÎåìÍ∏Ä Î™©Î°ù */}
      <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
        {mode === 'editor' ? (
          <>
            <div
              style={{
                position: 'relative',
                padding: styles.commentPadding,
                backgroundColor: '#ffffff',
                border: '1px solid #e5e7eb',
                borderRadius: '6px',
              }}
            >
              <button
                disabled={true}
                style={{
                  position: 'absolute',
                  top: '8px',
                  right: '8px',
                  width: '24px',
                  height: '24px',
                  color: '#d1d5db',
                  cursor: 'not-allowed',
                  border: 'none',
                  background: 'none',
                  fontSize: '16px',
                }}
              >
                √ó
              </button>
              <div style={{ paddingRight: '32px' }}>
                <div
                  style={{
                    fontWeight: '500',
                    color: '#1f2937',
                    marginBottom: '4px',
                  }}
                >
                  ÏÉòÌîå ÏÇ¨Ïö©Ïûê
                </div>
                <div
                  style={{
                    color: '#4b5563',
                    fontSize: '14px',
                    lineHeight: '1.5',
                    whiteSpace: 'pre-wrap', // ‚úÖ
                  }}
                >
                  Ïù¥Í≥≥Ïóê ÎåìÍ∏ÄÏù¥ ÌëúÏãúÎê©ÎãàÎã§. Î∞∞Ìè¨ ÌõÑÏóê Ïã§Ï†ú ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±Ìï† Ïàò
                  ÏûàÏäµÎãàÎã§.
                </div>
                <div
                  style={{
                    fontSize: '12px',
                    color: '#9ca3af',
                    marginTop: '8px',
                  }}
                >
                  {new Date().toLocaleDateString()}
                </div>
              </div>
            </div>
            <div
              style={{
                position: 'relative',
                padding: styles.commentPadding,
                backgroundColor: '#ffffff',
                border: '1px solid #e5e7eb',
                borderRadius: '6px',
              }}
            >
              <button
                disabled={true}
                style={{
                  position: 'absolute',
                  top: '8px',
                  right: '8px',
                  width: '24px',
                  height: '24px',
                  color: '#d1d5db',
                  cursor: 'not-allowed',
                  border: 'none',
                  background: 'none',
                  fontSize: '16px',
                }}
              >
                √ó
              </button>
              <div style={{ paddingRight: '32px' }}>
                <div
                  style={{
                    fontWeight: '500',
                    color: '#1f2937',
                    marginBottom: '4px',
                  }}
                >
                  Îòê Îã§Î•∏ ÏÇ¨Ïö©Ïûê
                </div>
                <div
                  style={{
                    color: '#4b5563',
                    fontSize: '14px',
                    lineHeight: '1.5',
                    whiteSpace: 'pre-wrap', // ‚úÖ
                  }}
                >
                  ÎåìÍ∏Ä ÏòàÏãúÏûÖÎãàÎã§.
                </div>
                <div
                  style={{
                    fontSize: '12px',
                    color: '#9ca3af',
                    marginTop: '8px',
                  }}
                >
                  {new Date().toLocaleDateString()}
                </div>
              </div>
            </div>
          </>
        ) : comments.length === 0 ? (
          <div
            style={{
              textAlign: 'center',
              color: '#6b7280',
              padding: '32px 0',
            }}
          >
            Ï≤´ Î≤àÏß∏ ÎåìÍ∏ÄÏùÑ ÎÇ®Í≤®Î≥¥ÏÑ∏Ïöî!
          </div>
        ) : (
          comments.map((comment) => (
            <div
              key={comment.id}
              style={{
                position: 'relative',
                padding: styles.commentPadding,
                backgroundColor: '#ffffff',
                border: '1px solid #e5e7eb',
                borderRadius: '6px',
              }}
            >
              <button
                onClick={() => setShowDeleteModal(comment.id)}
                style={{
                  position: 'absolute',
                  top: '8px',
                  right: '8px',
                  width: '24px',
                  height: '24px',
                  color: '#9ca3af',
                  cursor: 'pointer',
                  border: 'none',
                  background: 'none',
                  fontSize: '16px',
                  transition: 'color 0.2s',
                }}
                onMouseOver={(e) => (e.target.style.color = '#ef4444')}
                onMouseOut={(e) => (e.target.style.color = '#9ca3af')}
              >
                √ó
              </button>
              <div style={{ paddingRight: '32px' }}>
                <div
                  style={{
                    fontWeight: fontWeight === 'bold' ? 'bold' : '500',
                    color: comp.props?.color || '#1f2937',
                    marginBottom: '4px',
                    fontFamily: fontFamily,
                    textAlign: textAlign,
                    letterSpacing: letterSpacing + 'px',
                    textDecoration: textDecoration,
                    transform: italicTransform,
                  }}
                >
                  {comment.author}
                </div>
                <div
                  style={{
                    color: comp.props?.color || '#4b5563',
                    fontSize: '14px',
                    lineHeight: lineHeight,
                    whiteSpace: 'pre-wrap',
                    fontFamily: fontFamily,
                    textAlign: textAlign,
                    letterSpacing: letterSpacing + 'px',
                    textDecoration: textDecoration,
                    transform: italicTransform,
                  }}
                >
                  {comment.content}
                </div>
                <div
                  style={{
                    fontSize: '12px',
                    color: '#9ca3af',
                    marginTop: '8px',
                  }}
                >
                  {new Date(comment.createdAt).toLocaleDateString()}
                </div>
              </div>
            </div>
          ))
        )}
      </div>

      {/* ÏÇ≠Ï†ú ÌôïÏù∏ Î™®Îã¨ */}
      {showDeleteModal && (
        <div
          style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            backgroundColor: 'rgba(0, 0, 0, 0.5)',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            zIndex: 50,
          }}
        >
          <div
            style={{
              backgroundColor: '#ffffff',
              padding: styles.containerPadding,
              borderRadius: '8px',
              width: viewport === 'mobile' ? '280px' : '320px',
            }}
          >
            <h3
              style={{
                fontSize: '18px',
                fontWeight: '600',
                marginBottom: '16px',
                whiteSpace: 'pre-wrap', // ‚úÖ
              }}
            >
              ÎåìÍ∏Ä ÏÇ≠Ï†ú
            </h3>
            <p
              style={{
                color: '#4b5563',
                marginBottom: '16px',
                whiteSpace: 'pre-wrap', // ‚úÖ
              }}
            >
              ÎåìÍ∏Ä ÏûëÏÑ± Ïãú ÏûÖÎ†•Ìïú ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.
            </p>
            <input
              type="password"
              placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏"
              value={deletePassword}
              onChange={(e) => setDeletePassword(e.target.value)}
              style={{
                width: '100%',
                padding: styles.inputPadding,
                border: '1px solid #d1d5db',
                borderRadius: '6px',
                marginBottom: viewport === 'mobile' ? '12px' : '16px',
                outline: 'none',
                fontSize: styles.inputFontSize,
              }}
              onFocus={(e) => (e.target.style.borderColor = '#3b82f6')}
              onBlur={(e) => (e.target.style.borderColor = '#d1d5db')}
              onKeyPress={(e) => e.key === 'Enter' && handleDeleteComment()}
            />
            <div
              style={{
                display: 'flex',
                gap: '8px',
              }}
            >
              <button
                onClick={handleDeleteComment}
                style={{
                  flex: 1,
                  padding: styles.buttonPadding,
                  backgroundColor: '#dc2626',
                  color: '#ffffff',
                  borderRadius: '6px',
                  border: 'none',
                  cursor: 'pointer',
                  transition: 'background-color 0.2s',
                  fontSize: styles.inputFontSize,
                  whiteSpace: 'pre-wrap', // ‚úÖ
                }}
                onMouseOver={(e) =>
                  (e.target.style.backgroundColor = '#b91c1c')
                }
                onMouseOut={(e) => (e.target.style.backgroundColor = '#dc2626')}
              >
                ÏÇ≠Ï†ú
              </button>
              <button
                onClick={() => {
                  setShowDeleteModal(null);
                  setDeletePassword('');
                }}
                style={{
                  flex: 1,
                  padding: styles.buttonPadding,
                  backgroundColor: '#d1d5db',
                  color: '#374151',
                  borderRadius: '6px',
                  border: 'none',
                  cursor: 'pointer',
                  transition: 'background-color 0.2s',
                  fontSize: styles.inputFontSize,
                  whiteSpace: 'pre-wrap', // ‚úÖ
                }}
                onMouseOver={(e) =>
                  (e.target.style.backgroundColor = '#9ca3af')
                }
                onMouseOut={(e) => (e.target.style.backgroundColor = '#d1d5db')}
              >
                Ï∑®ÏÜå
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

export default CommentRenderer;